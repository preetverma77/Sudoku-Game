<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sudoku Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: white;
            color: #333;
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s ease;
            position: relative;
        }
        body.dark {
            background-color: black;
            color: white;
        }
        #dashboard-icon {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 24px;
            cursor: pointer;
            background: none;
            border: none;
            color: #333;
        }
        body.dark #dashboard-icon {
            color: white;
        }
        #toggle-bg {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            background: none;
            border: none;
            color: #333;
        }
        body.dark #toggle-bg {
            color: white;
        }
        .dropdown {
            display: none;
            position: absolute;
            top: 40px;
            left: 10px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 200px; /* Increased width */
        }
        body.dark .dropdown {
            background-color: #333;
            color: white;
        }
        .dropdown button {
            display: block;
            width: 100%;
            padding: 15px; /* Increased padding for larger buttons */
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 16px;
        }
        .dropdown button:hover {
            background-color: #f0f0f0;
        }
        body.dark .dropdown button:hover {
            background-color: #555;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }
        h1 {
            margin-bottom: 20px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            gap: 1px;
            margin: 20px auto;
            width: 450px;
            height: 450px;
            border: 2px solid #333;
        }
        .cell {
            width: 50px;
            height: 50px;
            border: 1px solid #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            background-color: white;
        }
        .cell input {
            width: 100%;
            height: 100%;
            border: none;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            background-color: transparent;
        }
        .cell.fixed {
            background-color: #f0f0f0;
        }
        .cell.fixed input {
            background-color: #f0f0f0;
        }
        .cell.invalid {
            background-color: red;
        }
        .buttons {
            margin-top: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 0 10px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            text-align: left;
        }
        body.dark .modal-content {
            background-color: #333;
            color: white;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        body.dark .close {
            color: white;
        }
    </style>
</head>
<body>
    <button id="dashboard-icon">â˜°</button>
    <div class="dropdown" id="dropdown-menu">
        <button id="new-game-menu">New Game</button>
        <button id="check-history">Check History</button>
        <button id="run-game">Run Game</button>
    </div>
    <button id="toggle-bg">ðŸŒ™</button>
    <div class="container">
        <h1>Sudoku Puzzle Game</h1>
        <div class="grid" id="sudoku-grid"></div>
        <div class="buttons">
            <button id="new-game">New Game</button>
            <button id="check-solution">Check Solution</button>
            <button id="rules-btn">Rules</button>
        </div>
    </div>

    <!-- Rules Modal -->
    <div id="rules-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Sudoku Rules</h2>
            <ul>
                <li>The puzzle is a 9x9 grid, divided into 9 smaller 3x3 boxes.</li>
                <li>Fill each row, column, and 3x3 box with numbers 1 through 9.</li>
                <li>No number can repeat in any row, column, or 3x3 box.</li>
                <li>Some numbers are already filled in as clues.</li>
                <li>Use logic to deduce the correct numbers for the empty cells.</li>
                <li>The game is complete when all cells are filled correctly.</li>
            </ul>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="history-close">&times;</span>
            <h2>Game History</h2>
            <div id="history-content">
                <p>No history available yet. Solve some puzzles to see them here!</p>
            </div>
        </div>
    </div>

    <script>
        const gridElement = document.getElementById('sudoku-grid');
        const newGameButton = document.getElementById('new-game');
        const checkSolutionButton = document.getElementById('check-solution');
        const toggleBgButton = document.getElementById('toggle-bg');
        const rulesBtn = document.getElementById('rules-btn');
        const modal = document.getElementById('rules-modal');
        const historyModal = document.getElementById('history-modal');
        const closeBtn = document.getElementsByClassName('close')[0];
        const historyCloseBtn = document.getElementById('history-close');
        const dashboardIcon = document.getElementById('dashboard-icon');
        const dropdownMenu = document.getElementById('dropdown-menu');
        const newGameMenu = document.getElementById('new-game-menu');
        const checkHistoryBtn = document.getElementById('check-history');
        const runGameBtn = document.getElementById('run-game');
        let puzzle = [];
        let solution = [];
        let history = JSON.parse(localStorage.getItem('sudokuHistory')) || [];

        // Function to fetch a new puzzle from the API
        async function fetchPuzzle() {
            try {
                const response = await fetch('https://sudoku-api.vercel.app/api/dosuku');
                const data = await response.json();
                puzzle = data.newboard.grids[0].value; // Initial puzzle
                solution = data.newboard.grids[0].solution; // Full solution
                renderGrid();
            } catch (error) {
                console.error('Error fetching puzzle:', error);
                alert('Failed to load puzzle. Please try again.');
            }
        }

        // Function to render the grid
        function renderGrid() {
            gridElement.innerHTML = '';
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.maxLength = 1;
                    input.pattern = '[1-9]';
                    if (puzzle[row][col] !== 0) {
                        input.value = puzzle[row][col];
                        cell.classList.add('fixed');
                        input.disabled = true;
                    } else {
                        input.addEventListener('input', (e) => {
                            const value = e.target.value;
                            if (!/^[1-9]$/.test(value)) {
                                e.target.value = '';
                                cell.classList.remove('invalid');
                                return;
                            }
                            // Check for violations
                            if (isValidMove(row, col, parseInt(value))) {
                                cell.classList.remove('invalid');
                            } else {
                                cell.classList.add('invalid');
                            }
                        });
                    }
                    cell.appendChild(input);
                    gridElement.appendChild(cell);
                }
            }
        }

        // Function to check if a move is valid (no duplicates in row, column, or box)
        function isValidMove(row, col, num) {
            // Check row
            for (let c = 0; c < 9; c++) {
                if (c !== col && getCellValue(row, c) === num) {
                    return false;
                }
            }
            // Check column
            for (let r = 0; r < 9; r++) {
                if (r !== row && getCellValue(r, col) === num) {
                    return false;
                }
            }
            // Check 3x3 box
            const boxRow = Math.floor(row / 3) * 3;
            const boxCol = Math.floor(col / 3) * 3;
            for (let r = boxRow; r < boxRow + 3; r++) {
                for (let c = boxCol; c < boxCol + 3; c++) {
                    if ((r !== row || c !== col) && getCellValue(r, c) === num) {
                        return false;
                    }
                }
            }
            return true;
        }

        // Helper function to get the value of a cell (from puzzle or user input)
        function getCellValue(row, col) {
            const cells = document.querySelectorAll('.cell input');
            const index = row * 9 + col;
            const value = cells[index].value;
            return value ? parseInt(value) : 0;
        }

        // Function to check the solution
        function checkSolution() {
            const cells = document.querySelectorAll('.cell input');
            let isCorrect = true;
            cells.forEach((input, index) => {
                const row = Math.floor(index / 9);
                const col = index % 9;
                const userValue = parseInt(input.value) || 0;
                if (userValue !== solution[row][col]) {
                    isCorrect = false;
                    input.parentElement.style.backgroundColor = 'red';
                } else {
                    input.parentElement.style.backgroundColor = 'lightgreen';
                }
            });
            if (isCorrect) {
                const solvedPuzzle = puzzle.map(row => row.slice()); // Copy puzzle
                history.push({ puzzle: solvedPuzzle, solvedAt: new Date().toISOString() });
                localStorage.setItem('sudokuHistory', JSON.stringify(history));
                alert('Congratulations! You solved the puzzle correctly.');
            } else {
                alert('Some cells are incorrect. Try again.');
            }
        }

        // Function to show history
        function showHistory() {
            const historyContent = document.getElementById('history-content');
            if (history.length === 0) {
                historyContent.innerHTML = '<p>No history available yet. Solve some puzzles to see them here!</p>';
            } else {
                historyContent.innerHTML = '<ul>';
                history.forEach((item, index) => {
                    historyContent.innerHTML += `<li>Puzzle ${index + 1} solved on ${new Date(item.solvedAt).toLocaleString()}</li>`;
                });
                historyContent.innerHTML += '</ul>';
            }
            historyModal.style.display = 'block';
        }

        // Toggle background color
        toggleBgButton.addEventListener('click', () => {
            document.body.classList.toggle('dark');
            toggleBgButton.textContent = document.body.classList.contains('dark') ? 'â˜€ï¸' : 'ðŸŒ™';
        });

        // Dashboard icon toggle
        dashboardIcon.addEventListener('click', () => {
            dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
        });

        // Menu buttons
        newGameMenu.addEventListener('click', () => {
            fetchPuzzle();
            dropdownMenu.style.display = 'none';
        });
        checkHistoryBtn.addEventListener('click', () => {
            showHistory();
            dropdownMenu.style.display = 'none';
        });
        runGameBtn.addEventListener('click', () => {
            fetchPuzzle();
            dropdownMenu.style.display = 'none';
        });

        // Rules modal
        rulesBtn.addEventListener('click', () => {
            modal.style.display = 'block';
        });
        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });
        historyCloseBtn.addEventListener('click', () => {
            historyModal.style.display = 'none';
        });
        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
            if (event.target === historyModal) {
                historyModal.style.display = 'none';
            }
            if (!dashboardIcon.contains(event.target) && !dropdownMenu.contains(event.target)) {
                dropdownMenu.style.display = 'none';
            }
        });

        // Event listeners
        newGameButton.addEventListener('click', fetchPuzzle);
        checkSolutionButton.addEventListener('click', checkSolution);

        // Load initial puzzle on page load
        fetchPuzzle();
    </script>
</body>
</html>